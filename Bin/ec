#!/bin/bash

[ -n "$TMPDIR" ] || TMPDIR="/tmp"

EMACSCLIENT_FLAGS=" -c -n -q"

function startup_if_not_running() {
    # adapted from http://www.emacswiki.org/emacs/EmacsClient#toc7
    if [ ! -e "$TMPDIR/emacs${UID}/server" ]; then
        emacs &
        while [ ! -e "$TMPDIR/emacs${UID}/server" ] ; do sleep 2 ; done
    fi
}

[ $# -eq 0 ] && exit 1

BIN=`which emacsclient`
[ -x $BIN ] || exit 2

startup_if_not_running

while [ $# -gt 0 ]; do
    read FILE_NAME LINE_NUM <<< $(echo $1 | sed -e 's/:\([0-9]\+\)$/\n\1/')
    if [ -n "$LINE_NUM" ]; then
        EMACS_LINE_NUM="+$LINE_NUM"
    else
        EMACS_LINE_NUM=""
    fi

    $BIN $EMACSCLIENT_FLAGS $EMACS_LINE_NUM $FILE_NAME
    shift
done
